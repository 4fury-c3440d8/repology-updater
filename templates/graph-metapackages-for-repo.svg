{%- set width = 1140 -%}
{%- set height = 400 -%}

{%- macro x(value, offset=0) %}{{ ( (1.0 - value) * width + offset ) | round(2) }}{% endmacro -%}
{%- macro y(value, offset=0) %}{{ ( ((1.0 - value) * 0.85 + 0.05) * height + offset ) | round(2) }}{% endmacro -%}

{%- macro line(field, color) %}
{#### line shadow ####}
    <g stroke="gray" stroke-width="3">
    {% for point in datapoints if field in point %}
    {% if not loop.first and field in prev %}
        <line x1="{{ x(point.pos, 0.5) }}" y1="{{ y(point[field], 1) }}" x2="{{ x(prev.pos, 0.5) }}" y2="{{ y(prev[field], 1) }}" />
    {% endif %}
    {% set prev = point %}
    {% endfor %}
    </g>
{#### point shadow ####}
    <g fill="gray">
    {% for point in datapoints if field in point %}
        <circle cx="{{ x(point.pos, 0.5) }}" cy="{{ y(point[field], 1) }}" r="4" />
    {% endfor %}
    </g>
{#### line ####}
    <g stroke="{{ color }}" stroke-width="3">
    {% for point in datapoints if field in point %}
    {% if not loop.first and field in prev %}
        <line x1="{{ x(point.pos) }}" y1="{{ y(point[field]) }}" x2="{{ x(prev.pos) }}" y2="{{ y(prev[field]) }}" />
    {% endif %}
    {% set prev = point %}
    {% endfor %}
    </g>
{#### point ####}
    <g fill="{{ color }}" stroke-width="3">
    {% for point in datapoints if field in point %}
        <circle cx="{{ x(point.pos) }}" cy="{{ y(point[field]) }}" r="4" />
    {% endfor %}
    </g>
{#### point eye ####}
    <g fill="white" stroke-width="3">
    {% for point in datapoints if field in point %}
        <circle cx="{{ x(point.pos) }}" cy="{{ y(point[field]) }}" r="2" />
    {% endfor %}
    </g>
{% endmacro -%}

<svg xmlns="http://www.w3.org/2000/svg" width="{{ width }}" height="{{ height }}">
{#### background stripes ####}
{% for day in range(numdays) %}
{% if loop.index % 2 %}
    <rect x="{{ x((day+1)/numdays) }}" width="{{ ( width / numdays ) | round(2) }}" height="{{ height }}" fill="#00000010" />
{% endif %}
{% endfor %}
{#### lines ####}
{{- line('num_metapackages', '#000000') -}}
{{- line('num_metapackages_newest', '#5cb85c') -}}
{{- line('num_metapackages_unique', '#5bc0de') -}}
{{- line('num_metapackages_outdated', '#d9534f') -}}
{#### labels ####}
    <g fill="#000" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
    {% for day in range(0, numdays - 1) %}
        <text x="{{ x((day+1)/numdays) }}" y="{{ height - 5 }}">{{ day+1 }} day(s) ago</text>
    {% endfor %}
    </g>
</svg>
